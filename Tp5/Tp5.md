# Requêtes SQL - Gestion des Clients et Visionnages

Ce document décrit les différentes opérations SQL réalisées sur les tables `Client` et `Visionnage`, y compris la création de tables, l'insertion de données, et des requêtes d'extraction et de manipulation des données.

```sql
-- Suppression des tables existantes `Client` et `Visionnage`
DROP TABLE Client CASCADE CONSTRAINTS;
DROP TABLE Visionnage CASCADE CONSTRAINTS;

-- Création de la table `Client`
CREATE TABLE Client (
    idClient INT PRIMARY KEY,
    prenomClient VARCHAR(50),
    nomClient VARCHAR(50),
    planClient VARCHAR(50) CHECK (planClient IN ('Essentiel avec publicité', 'Essentiel', 'Standard', 'Supérieur', 'Premium'))
);

-- Création de la table `Visionnage`
CREATE TABLE Visionnage (
    idClient INT,
    horoDatageDebut TIMESTAMP PRIMARY KEY,
    idFilm NUMBER(10) NOT NULL,
    numVersion NUMBER(1) NOT NULL,
    minuteStop INT,
    horoDatageFin TIMESTAMP,
    FOREIGN KEY (idClient) REFERENCES Client(idClient)
    --PRIMARY KEY(idclient,horoDatageDebut), -- Commenté, car un PRIMARY KEY existe déjà sur horoDatageDebut
    --FOREIGN KEY (idClient) REFERENCES Client(idClient) -- Redondant, déjà utilisé
);

-- Insertion des données dans la table `Client`
INSERT INTO Client(idClient, PrenomClient, nomClient, planClient) VALUES
(882213, 'William', 'Blake', 'Essentiel avec publicité'),
(114455, 'Helena', 'Lovett', 'Supérieur'),
(446672, 'Jeanne', 'Moreau', 'Premium');

-- Insertion des données dans la table `Visionnage`
INSERT INTO Visionnage VALUES (882213, '08-02-2024 00:06:00', 792307, 1, 31, '08-02-2024 00:41:00');
INSERT INTO Visionnage VALUES (882213, '08-02-2024 20:41:00', 792307, 1, NULL, '08-02-2024 23:49:00');
INSERT INTO Visionnage VALUES (114455, '14-02-2024 22:23:00', 398818, 4, NULL, '15-02-2024 00:34:00');
INSERT INTO Visionnage VALUES (114455, '15-02-2024 19:16:00', 398818, 2, 86, '15-02-2024 19:32:00');
INSERT INTO Visionnage VALUES (114455, CURRENT_TIMESTAMP - INTERVAL '1' DAY, 7345, 3, 120, CURRENT_TIMESTAMP - INTERVAL '22' HOUR);
INSERT INTO Visionnage VALUES (114455, CURRENT_TIMESTAMP, 7345, 3, NULL, NULL);
INSERT INTO Visionnage VALUES (446672, CURRENT_TIMESTAMP, 496243, 5, NULL, NULL);

-- Validation des transactions
COMMIT;

-- Suppression du client avec idClient 114455
-- DELETE FROM Client WHERE prenomclient ='Helena' AND nomclient = 'Lovett'; -- Commenté

DELETE FROM Client WHERE idClient = 114455;

-- Annulation de la suppression
ROLLBACK;

-- Réinsertion de données dans `Visionnage` après le ROLLBACK
INSERT INTO Visionnage VALUES (114455, CURRENT_TIMESTAMP - INTERVAL '1' HOUR, 7345, 6, NULL, CURRENT_TIMESTAMP + INTERVAL '1' HOUR);

-- Insertion de nouveaux clients
INSERT INTO Client(idClient, PrenomClient, nomClient, planClient) VALUES
(328566, 'Matthieu', 'DaCruz', 'Essentiel'),
(324677, 'Iliann', 'Fonseca', 'Essentiel');

-- Requête pour compter le nombre de films visionnés par client
SELECT C.idclient, C.nomclient, C.prenomclient, COUNT(V.idfilm) AS nombre_films
FROM Client C
LEFT JOIN Visionnage V ON C.idClient = V.idClient
GROUP BY C.idclient, C.nomclient, C.prenomclient;

-- Affichage de la structure d'une autre table (non fournie ici)
-- DESC bdfilm.version; -- Commenté
